
def grip():
    set_digital_outputs([-1, -2, -3, -4, -5])
    wait(1)
    set_digital_output(4)
   
def toast_grip():
    set_digital_outputs([-1, -2, -3, -4, -5])
    wait(1)
    set_digital_output(2)

def tool_grip():
    set_digital_outputs([-1, -2, -3, -4, -5])
    wait(1)
    set_digital_output(1)

def full_open():
    set_digital_outputs([-1, -2, -3, -4, -5])
    wait(1)
    set_digital_output(3)

def home():
    movej(posj(-80.78, 24.17, -78.94, 161.78, 113.56, 61.15), 50, 50)# 집게 받는 곳
    tool_grip()
    #posx(42.4, 311.47, 371.74, 5.52, 162.75, 4.75) # 위치
    wait(1)
    
def toast_zone1():
    #toast1
    '''
    movej(posj(-51.71, 17.85, -66.94, 158.9, 108.61, 29.5), 30, 30) # 식빵 위
    movej(posj(-64.08, 23.98, -90.61, 163.97, 81.31, 27.48), 30,30) # 식빵
    '''
    
    # toast1
    movej(posj(-78.87, 17.3, -72.21, 170.89, 93.9, 14.63), 60, 60) # 식빵 위
    movej(posj(-86.55, -9.44, -48.26, 176.87, 103.15, 4.3), 60,60) # 식빵
    
    toast_grip() # 식빵 잡기
    wait(1)
    movej(posj(-86.55, 4.86, -48.45, 176.87, 103.16, 4.3), 60, 60) # 위로 올라오기
    
def toast_zone2():
    #toast1
    '''
    movej(posj(-51.71, 17.85, -66.94, 158.9, 108.61, 29.5), 30, 30) # 식빵 위
    movej(posj(-64.08, 23.98, -90.61, 163.97, 81.31, 27.48), 30,30) # 식빵
    '''
    movej(posj(-99.93, 11.62, -67.71, 182.51, 94.9, -5.52),60,60)
    movej(posj(-99.61, 3.82, -67.26, 183.44, 88.63, -5.52),60,60)
    
    toast_grip() # 식빵 잡기
    wait(1)
    movej(posj(-99.72, 13.06, -65.41, 184.04, 91.08, -5.52),60,60)
    
    
def egg_wash():
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60) # 계란물 바트 위
    movej(posj(-17.58, -38.02, -23.46, 169.24, 113.95, 115.45),30,30) # 계란물 바트로 내려가기
    
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    movej(posj(-15.68, -23.32, -24.92, 167.52, 116.05, 115.43),60,60)
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    movej(posj(-15.68, -23.32, -24.92, 167.52, 116.05, 115.43),60,60)
    wait(1)
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    movej(posj(-15.68, -23.32, -24.92, 167.52, 116.05, 115.43),60,60)
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    movej(posj(-15.68, -23.32, -24.92, 167.52, 116.05, 115.43),60,60)
    wait(1)
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    movej(posj(-15.68, -23.32, -24.92, 167.52, 116.05, 115.43),60,60)
    movej(posj(-17.45, -19.91, -21.62, 169.22, 116.06, 115.45),60,60)
    wait(1)

    
def pripen1_in():    
    movej(posj(15.05, -7.03, -31.55, 178.52, 118.55, 115.45),60,60) # 작업 준비 위치 대기
    movej(posj(57.9, -9.28, -38.84, 181.25, 120.17, 145.49),60,60)
    
    movej(posj(26.52, 17.78, -88.47, 205.78, 93.06, 29.06),60,60) # 프라이팬 내려놓을 준비
    movej(posj(-15.65, 16.61, -110.69, 227.5, 99.81, -14.31),60,60)# 기울이기
    tool_grip()
    wait(1)
    movel(posx(-229.95, -175.27, 256.1, 90.66, -139.85, -93.51),40,40)
    movej(posj(-26.02, 13.16, -87.85, 221.07, 118.82, -14.18),40,40)
    
def pripen1_rot():
    movel(posx(-231.44, -115.83, 328.61, 90.31, -138.28, -93.97),100,100) # 대기위치로 나오기
    
    movej(posj(-20.9, 13.31, -107.05, 218.21, 102.02, -17.68),60,60) # 프라이팬 가까이
    movej(posj(-41.36, 4.09, -123.84, 223.35, 103.92, -45.8),50,50) # 각도 눕히기
    
    #뒤집개 밀어넣기
    movel([-15, 0, -2, 0, 0, -5], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)

    movel([30, 0, -2, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, -2, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([30, 0, -2, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, -2, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
  
    movel([30, 0, -2, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    movel([-15, 0, -2, 0, 0, -5], mod=1, t=0.5)
    
    toast_grip()
    wait(1)
    movel([0,0,60,0,0,0], 80,80, mod=1)
    movej(posj(-30.32, 8.39, -114.17, 231.72, 107.68, 149.48),80,80)
    movej(posj(-27.45, 7.63, -119.57, 228.96, 99.89, 148.98),60,60)
    
    tool_grip()
    wait(1)
    movej(posj(-23.64, 11.85, -112.43, 226.87, 101.98, 159.16),50,50)
    posx(-247.92, -159.37, 250.85, 90.85, -128.28, 93.16)
    movel(posx(-247.96, -159.07, 250.93, 90.92, -138.92, 93.25),40,40)
    movej(posj(-29.83, 10.37, -98.4, 223.29, 113.5, 162.56),40,40)
    
    
def pripen1_out():
    movej(posj(-28.12, 18.42, -95.12, 224.96, 116.66, 167.16),70,70)
    movej(posj(-28.14, 9.51, -108.69, 220.28, 104.85, 155.2),50,50)
    
    movel(posx(-247.02, -140.75, 238.66, 92.43, -133.41, 93.77),60,60)
    
    movej(posj(-38.66, -8.74, -121.45, 224.27, 103.31, 125.38),50,50)
    #뒤집개 밀어넣기
    movel([-15, 0, -1, 0, 0, -5], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)

    movel([30, 0, -1, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, -1, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([30, 0, -1, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, -1, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
  
    movel([30, 0, -1, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    movel([-15, 0, -1, 0, 0, -5], mod=1, t=0.5)
    
    toast_grip()
    wait(1)
    movej(posj(-25.5, 11.4, -110.88, 234.75, 110.44, 156.92),60,60)
    
    movej(posj(-21.57, -6.08, -88.54, 236.77, 109.74, 161.41),80,80) # 프라이팬 1, 2 사이

def pripen2_in():
    
    movej(posj(15.05, -7.03, -31.55, 178.52, 118.55, 115.45),60,60) # 작업 준비 위치 대기
    movej(posj(17.62, -26.12, -23.18, 203.8, 117.12, 115.45),60, 60) # 프라이팬 위로 오기
    
    #보정 필요
    movej(posj(20.84, -31.76, -22.96, 204.16, 116.71, 36.71),60,60) # 내려둘 준비
    
    movej(posj(-5.69, -24.06, -62.04, 223.71, 102.63, -4.62),50,50) # 각도 기울여서 
    tool_grip()
    wait(1)
    movel(posx(-490.52, -151.28, 265.21, 96.2, -132.7, -86.3),50,50) # 놓고 살짝 뒤로
    movel(posx(-490.52, -151.28, 400.22, 96.2, -132.7, -86.3),60,60) # 위로 나오기
    
def pripen2_rot():
    movej(posj(-20.38, -21.55, -56.56, 227.97, 114.61, -7.24),80,80) # 위로 나오기
    
   # 23초 소요 1분 정도에 작업하면 좋을 듯
    #wait(55)
    movej(posj(-5.32, -21.66, -60.05, 215.05, 105.79, -3.32),60,60) # 프라이팬 가까이 닿게
    movel(posx(-487.26, -160.86, 265.21, 97.47, -144.58, -83.78),60,60) # 살짝 앞으로
    movej(posj(-17.91, -26.94, -78.67, 231.27, 98.35, -20.79),50,50) # 구부리고
    movej(posj(-19.38, -32.76, -77.01, 233.53, 102.08, -28.13),50,50) # 더 구부리고
    
    #뒤집개 밀어넣기
    movel([-15, 0, 0, 0, 0, -5], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)

    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, 0, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, 0, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
  
    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    movel([-15, 0, 0, 0, 0, -5], mod=1, t=0.5)
    
    # 토스트 잡기
    toast_grip()
    wait(1)
    movel(posx(-490.04, -158.73, 178.34, 90.04, -119.45, -85.99),60,60)
    movel(posx(-490.04, -158.73, 275.34, 90.04, -119.45, -85.99),80,80)
    movej(posj(-16.66, -19.34, -82.99, 237.41, 98.12, 160.16),100,100)
    
    movel(posx(-490.99, -158.78, 220.28, 90.05, -119.45, 89.34),60,60)
    
    tool_grip()
    wait(1)
    movel(posx(-502.99, -158.78, 220.28, 90.06, -127.67, 89.35),50,50)
    movel(posx(-502.99, -158.78, 245.88, 90.06, -127.67, 89.35),50,50)
    movel(posx(-502.99, -158.78, 245.86, 92.3, -135.72, 92.98),50,50)
    movej(posj(-27.12, -23.99, -75.49, 234.89, 107.89, 156.38),50,50)
    
    #wait(45)
def pripen2_out():

    movej(posj(-20.38, -21.55, -56.56, 227.97, 114.61, -7.24),80,80)
    movej(posj(-4.97, -23.26, -59.16, 214.21, 103.41, 183.87),70,70) # 프라이팬 가까이 닿게
    movel(posx(-503.72, -179.52, 265.99, 99.29, -145.96, 98.82),70,70) # 살짝 앞으로
    movej(posj(-14.07, -28.77, -71.27, 228.56, 101.62, 160.95),60,60) # 구부리고
    movej(posj(-22.38, -32.65, -83.15, 236.32, 100.51, 151.84),60,60) # 더 구부리고
    
    #뒤집개 밀어넣기
    movel([-15, 0, 0, 0, 0, -5], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)

    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, 0, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    
    movel([-30, 0, 0, 0, 0, -10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
  
    movel([30, 0, 0, 0, 0, 10], 10, 10, mod=1, t=0.5)
    movel([0, -10, 0, 0, 0, 0], 10, 10, mod=1, t=0.5)
    movel([-15, 0, 0, 0, 0, -5], mod=1, t=0.5)
    
    # 토스트 잡기
    toast_grip()
    wait(1)
    movel(posx(-490.4, -164.73, 300.23, 89.81, -119.26, 92.03), 50, 50) # 프라이팬에서 올라오기
    movej(posj(-13.61, -3.34, -91.26, 239.38, 101.25, 167.92),50,50) # 프라이팬 1,2, 사이

def cutting_board():
    movej(posj(44.3, -12.15, -77.17, 219.2, 59.37, 215.36),60,60) # 도마 위로
    movej(posj(48.1, -19.82, -79.36, 218.78, 49.29, 212.06),50,50) # 도마 위치
    tool_grip()
    wait(1)
    movej(posj(49.96, -21.78, -72.94, 208.98, 54.72, 218.11),50,50)
    movej(posj(33.54, -7.68, -63.07, 211.91, 83.56, 215.89),50,50)


    
    movej(posj(22.18, 8.62, -58.8, 173.1, 119.15, 197.97),50,50) # 살짝 옆으로
    
    
    
def check_tool():
   movej(posj(87.02, -17.75, -88.8, 6.59, -22.25, -90), 30, 30) # 노트북 위치 옆으로 오기


def full_process():
    home()
    toast_zone1()
    egg_wash()
    pripen1_in()
    movej(posj(-27.43, -9.3, -82.91, 239.67, 118.03, 159.09),90,90) # 프라이팬 사이 중간 쉼터
    toast_zone2()
    egg_wash()
    
    pripen2_in()
    movej(posj(15.86, 4.56, -49.39, 177.94, 126.35, 194.46),90,90) # 계란물 중간 쉼터
    wait(16)
    
    pripen1_rot()
    movej(posj(-27.43, -9.3, -82.91, 239.67, 118.03, 159.09),90,90) # 프라이팬 사이 중간 쉼터
    pripen2_rot()
    movej(posj(-27.43, -9.3, -82.91, 239.67, 118.03, 159.09),90,90) # 프라이팬 사이 중간 쉼터
    
    pripen1_out()
    cutting_board()
    
    pripen2_out()
    cutting_board()

"""
아래부터 메인문
"""
#movej(posj(0, 0, 0, 0, 0, 0), 30, 30)
#wait(5)
#movel([0,0,100,0,0,0], 30, 30, mod=1)

def server_loop():
    sock = server_socket_open(20000)  # 서버 열기
    print("로봇 서버 소켓 열림")
    wait(1)

    try:
        while True:
            res, rx_data = server_socket_read(sock, length=64, timeout=1)
            # res=통신 성공이면 양수, 아니면 음수
            if res > 0:
                msg = rx_data.decode().strip()  # 수신 데이터 디코드 + 공백/개행 제거
                tp_log(str(msg))

                # === 제어 명령 분기 ===
                if msg == 'home':
                    home()
                    server_socket_write(sock, b"DONE")

                elif msg == 'tos1':
                    toast_zone1()
                    server_socket_write(sock, b"DONE")

                elif msg == 'tos2':
                    toast_zone2()
                    server_socket_write(sock, b"DONE")

                elif msg == 'egg':
                    egg_wash()
                    server_socket_write(sock, b"DONE")

                elif msg == 'pen1':
                    pripen1_in()
                    pripen1_rot()
                    pripen1_out()
                    server_socket_write(sock, b"DONE")

                elif msg == 'pen2':
                    pripen2_in()
                    pripen2_rot()
                    pripen2_out()
                    server_socket_write(sock, b"DONE")
                    
                elif msg == 'grip1':
                    tool_grip()
                    server_socket_write(sock, b"DONE")
                    
                elif msg == 'grip2':
                    toast_grip()
                    server_socket_write(sock, b"DONE")

                elif msg == 'grip3':
                    grip()
                    server_socket_write(sock, b"DONE")

                elif msg == 'open':
                    full_open()
                    server_socket_write(sock, b"DONE")
                elif msg == 'full':
                    full_process()
                    server_socket_write(sock, b"DONE")
                elif msg == 'home':
                    home()
                    server_socket_write(scok, b"DONE")
                elif msg == 'q':
                    break

                else:
                    server_socket_write(sock, b"UNKNOWN_CMD")

            else:
                # 타임아웃 등으로 아무것도 안 왔을 때 대기
                wait(0.1)
    finally:
        server_socket_close(sock)
        tp_log("서버 소켓 종료")

# 실행
server_loop()
